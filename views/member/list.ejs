<!doctype html>
<html class="x-admin-sm">
<% include ../public/iframe_header %>
<style>
    .citybox{
        padding-right: 10px;
    }
    .citybox label{
        width: 40px
    }
    .citybox select{
        width: 120px
    }
</style>

<body>
    <div class="x-body">
        <div class="layui-row">
            <form class="layui-col-md12 x-so" style="margin-bottom: 10px" onsubmit="return saveReport();">
                <div class="layui-input-inline">
                    <div class="citybox">
                        <label class="city-label" for="seachprov">省份</label>
                        <select class="layui-select" id="seachprov" name="seachprov" onchange="changeComplexProvince(this.value, sub_array, 'seachcity', 'seachdistrict');"></select>
                        <label class="city-label" for="homecity">城市</label>
                        <select class="layui-select" id="seachcity" name="homecity" onchange="changeCity(this.value,'seachdistrict','seachdistrict');"></select>
                        <label class="city-label" for="seachdistrict">区县</label>
                        <span id="seachdistrict_div">
                            <select class="layui-select" id="seachdistrict" name="seachdistrict"></select>
                        </span>
                    </div>
                </div>
                <div class="layui-input-inline">
                    <input style="min-width: 260px" type="text" name="searchData" placeholder="请输入编号、会员昵称、会员姓名、手机号" autocomplete="off" class="layui-input ">
                </div>
                <button type="submit" class="layui-btn" lay-filter="sreach" onclick="showAreaID()"><i class="layui-icon">&#xe615;</i></button>
            </form>
        </div>
        <table class="layui-hide" id="demo" lay-filter="test"></table>
    </div>
    <script type="text/html" id="toolbar">
        <div class="layui-table-tool-temp">
            <div class="layui-inline" lay-event="delete"><i class="layui-icon layui-icon-delete"></i></div>
        </div>
</script>
    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="address">收货地址管理</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
    <script type="text/javascript" src="js/area.js"></script>
    <script type="text/javascript" src="js/AreaData_min.js"></script>
    <script>
    $(function() {
        initComplexArea('seachprov', 'seachcity', 'seachdistrict', area_array, sub_array, '0', '0', '0');
    });

    //得到地区码
    function getAreaID() {
        var area = 0;
        if ($("#seachdistrict").val() != "0") {
            area = $("#seachdistrict").val();
        } else if ($("#seachcity").val() != "0") {
            area = $("#seachcity").val();
        } else {
            area = $("#seachprov").val();
        }
        return area;
    }

    function showAreaID() {
        //地区码
        var areaID = getAreaID();
        //地区名
        var areaName = getAreaNamebyID(areaID);
        alert("您选择的地区码：" + areaID + "      地区名：" + areaName);
    }

    //根据地区码查询地区名
    function getAreaNamebyID(areaID) {
        var areaName = "";
        if (areaID.length == 2) {
            areaName = area_array[areaID];
        } else if (areaID.length == 4) {
            var index1 = areaID.substring(0, 2);
            areaName = area_array[index1] + " " + sub_array[index1][areaID];
        } else if (areaID.length == 6) {
            var index1 = areaID.substring(0, 2);
            var index2 = areaID.substring(0, 4);
            areaName = area_array[index1] + " " + sub_array[index1][index2] + " " + sub_arr[index2][areaID];
        }
        return areaName;
    }
    </script>
    <script>
    layui.use(['laydate', 'table', 'layer'], function() {
        var laydate = layui.laydate,
            table = layui.table,
            layer = layui.layer;

        //执行一个laydate实例
        laydate.render({
            elem: '#start' //指定元素
        });

        //执行一个laydate实例
        laydate.render({
            elem: '#end' //指定元素
        });

        //第一个实例
        var tableIns = table.render({
            elem: '#demo',
            url: '/api_admin/member',
            page: true,
            toolbar: '#toolbar',
            cols: [
                [
                    { type: 'checkbox', fixed: 'left' },
                    { field: 'id', title: '编号', width: 60 },
                    {
                        field: 'img',
                        title: '头像',
                        width: 100,
                        align: 'center',
                        templet(d) {
                            if(d.img){
                                return `<img width="28" height="28" src="${d.img}" alt="会员头像"></img>`
                            }else{
                                return `<img width="28" height="28" src="/images/logo.jpg" alt="会员头像"></img>`
                            }
                        }
                    },
                    { field: 'nickname', title: '用户昵称', width: 120 },
                    { field: 'name', title: '名字', width: 120 },
                    {
                        field: 'sex',
                        title: '性别',
                        width: 80,
                        align: 'center',
                        templet(d) {
                            if(d.sex == 1){
                                return '男'
                            }else if(d.sex == 2){
                                return '女'
                            }else{
                                return ''
                            }
                        }
                    },
                    { field: 'phone', title: '手机号码', width: 120 },
                    { field: 'provinces', title: '所在省市' ,templet(d){
                        if(d.provinces){
                            return provinces + city
                        }else{
                            return ''
                        }
                    }},
                    { title: '操作', align: 'center', toolbar: '#barDemo', width: 200, fixed: 'right' }
                ]
            ]
        });

        //监听头工具栏事件
        table.on('toolbar(test)', function(obj) {
            var checkStatus = table.checkStatus(obj.config.id),
                data = checkStatus.data; //获取选中的数据
            switch (obj.event) {
                case 'delete':
                    if (data.length === 0) {
                        layer.msg('请选择需要删除的管理员');
                    } else {
                        const ids = []
                        for (var value of data) {
                            ids.push(value.id)
                        }
                        del(ids)
                    }
                    break;
            };
        });

        //监听行工具事件
        table.on('tool(test)', function(obj) {
            console.log(obj)
            var data = obj.data,
                layEvent = obj.event;
            if (layEvent === 'del') {
                del([data.id])
            }else if (layEvent === 'address') {
                x_admin_show('收货地址管理', '/address?member=' + data._id)
            }
        });

        function del(ids) {
            layer.confirm('确认要删除吗？', function(index) {
                const idsUrl = ids.join(',')
                $.get("/api_admin/member/del?ids=" + idsUrl, function(data, status) {
                    if (data.code === 0) {
                        layer.msg(data.msg, { icon: 1 });
                        tableIns.reload();
                    } else {
                        layer.msg(data.msg);
                    }
                });
            });
        };

        window.saveReport = function() {
            console.log($('#selProvince2').val())
            const searchData = $('input[name="searchData"]').val()
            tableIns.reload({
                where: {
                    searchData: searchData
                },
                page: {
                    curr: 1
                }
            });
            return false;
        }
    });
    </script>
    <% include ../public/iframe_footer %>
</body>

</html>